`timescale 1ns / 1ps
`include "defines.vh"
`include "csr_defines.vh"

module dram_fifo (
    input wire clk,
    input wire rst,

    input wire flush,

    input wire [1:0] enqueue_en, //й—‚е‚™иѓ¶жћЄзјЃиЇІз‰“е®•ж›ўжЈѓеЁґз­№з¶ЃйЏЃе‚ћж‡ћйЉ‰гѓ®в‚¬ж’»жўєйЌЏз…ЋеўЇй–ёг„¤еЌіе®•г€¤еј¶йЋіо„Ђй…Је®•е •ж•ђйЌЊж°«еЈ•й—Ѓе‘ЉеЉ–и¤°е†®еџўй”џпї?
    input wire [`DECODE_DATA_WIDTH - 1:0] enqueue_data1, //й—‚е‚љеЂ·й‘іи€µзЃ™зј‚дЅЅо‡§йђ—ж’із•·йЏ‡г€Ўо—€жїћеЇёо„ІзјЌдѕЂеј«йЌђо†јзЈјжї®ж©†еЋѕй€§о„‰е‰џе§Љи™№зґ’е§—е—з•¶й—Ѓз»ољ…е¦«ж¶ље€’жї е›Ёж™ёй–їз‡‚ж‹·
    input wire [`DECODE_DATA_WIDTH - 1:0] enqueue_data2, 

    input wire [1:0] invalid_en, // й—‚е‚™жµ‡е¦—г„©ж‡—й‘ёећ«ж« жїЎг‚‚еЃ“й–»пЅ…зЃљз»—з†јеџЂйЎ’в‚¬йЎ•пЅ‰еґ№йЎђг€ўзЄћй–»еєЇз¶†йЌ‹е‘ґж‚µй€©е†Єз®ѕйЏ‰е ќеўЅз»‰о„„жџ›жђґв†з…јзЂ№ж›џољ…ићЈй–је§ђеЂђйЏЂжЉЅжўєйђђи—‰еЉљй–ёз†ёеЇ§з»»ж¶ўж•“й”џпї?
    output wire [`DECODE_DATA_WIDTH - 1:0] dequeue_data1, //й—‚е‚љеЂ·з»Ђдѕўге№‰й”џзЉІећ‚йђ иЅ°и­¦еЁ“е©љжџ¦е¦ЇзЊґзґљй–їжї†о°йЏ…жї‹жџ›зЃће‰§о•Ій–»еє®е‰џе§Љи™№зґ’е§—е—з•¶й—Ѓз»ољ…е¦«ж¶ље€’жї е›Ёж™ёй–їз‡‚ж‹?
    output wire [`DECODE_DATA_WIDTH - 1:0] dequeue_data2,
    
    output wire get_data_req,
    output wire full,
    output wire empty
);

    reg [`DECODE_DATA_WIDTH - 1:0] ram [`DEPTH - 1:0];

    // й—‚е‚љеЂёйЌЉжђЃеґЇжµјжќ‘зЄ—йЋјж·¬еЉЌйЌ‹е‹¬гЃ„йЋєж€ќоЃ©зјЃв‚¬йЌђв•ѓз®ѕй–ёв„ѓГЄжї®е џз№›йЌ«жї€еџЈй–єеІўге–“йЋ·зЉ»ећѕй“Џо‚¤еЅІзј‚е‚™жµ‡ж¤ґе“ҐжЌўйЌ«жїђжЅ–е©µе‚љж†ЎйЌ‹е‹ЇжџЎзЂЈйќ›дє—зјЃо†ЅжЌ‡йЏЊпЅ‰ж‚©йЌ™е¤ЉзЄ›зј‚дѕ‡е™®йЌЁи·єо‡ЈйЋ¶иЉҐеЃ„й–»ж’іжµ·йЎ”е¤ђжўєз’єг„Ґж«ђй–№е‡¤ж‹?
    reg [$clog2(`DEPTH) - 1:0] head;    
    reg [$clog2(`DEPTH) - 1:0] tail;   

    reg [$clog2(`DEPTH) - 1:0] head_plus;   
    reg [$clog2(`DEPTH) - 1:0] tail_plus;  


    integer j;

    always @(posedge clk) 
    begin
        if(rst || flush)
        begin
            for(j=0;j<8;j=j+1)
            begin
                ram[j] <= 0;
            end
            tail <= 0;
            tail_plus <= 1;
            head <= 0;
            head_plus <= 1;
        end
        else 
        begin
            case({invalid_en,enqueue_en})
            4'b1111:begin
                tail <= tail + 2;
                tail_plus <= tail_plus + 2;
                head <= head + 2;
                head_plus <= head_plus + 2;
                ram[head][0] <= 0;
                ram[head_plus][0] <= 0;
                ram[tail] <= enqueue_data1;
                ram[tail_plus] <= enqueue_data2;
            end
            4'b1011:begin
                tail <= tail + 2;
                tail_plus <= tail_plus + 2;
                head <= head + 1;
                head_plus <= head_plus + 1;
                ram[head][0] <= 0;
                ram[tail] <= enqueue_data1;
                ram[tail_plus] <= enqueue_data2;
            end
            4'b0111:begin
                tail <= tail + 2;
                tail_plus <= tail_plus + 2;
                head <= head + 1;
                head_plus <= head_plus + 1;
                ram[head][0] <= 0;
                ram[tail]     <= enqueue_data1;
                ram[tail_plus] <= enqueue_data2;
            end
            4'b0011:begin
                tail <= tail + 2;
                tail_plus <= tail_plus + 2;
                ram[tail]     <= enqueue_data1;
                ram[tail_plus] <= enqueue_data2;
            end
            4'b1100:begin
                head <= head + 2;
                head_plus <= head_plus + 2;
                ram[head][0] <= 0;
                ram[head_plus][0] <= 0;
            end
            4'b1000:begin
                head <= head + 1;
                head_plus <= head_plus + 1;
                ram[head][0] <= 0;
            end
            4'b0100:begin
                head <= head + 1;
                head_plus <= head_plus + 1;
                ram[head][0] <= 0;
            end
            default:;
            endcase
        end
    end


    // й—‚е‚љеЂёйЌЉжђЃеґђе®„ж‡ЉеЅ’еґ¶и¤‰йЏ‹ж ­жџЎйЌҐгѓҐзЃ©зјЃж„­ољЉйЏЊз†јж‚§йЌ«з†єе‡Ўй—Ѓе‘Љећ№жї®ж’®еџћйЋґпёЅеЃђйђЋењ­е§ґйЎҐжї€зґ“жµЈе“„оўгЊй–ёг„Ґз€јеЇ®е©љж•ђжѕ¶е©„о…єй—ЃжЊЋз№‚йЋІж¶ўе№зјЃжЁјеЋёй—Ѓе‘Љдѕ—йЌ жҐ…еґђйЋ°з‰€з…›зЂ№в‚¬зЂЈо„‚з€йђЋи§„жґз”ЇжЋ•зЃ’й–»з‚ґзЁ€й€§о„ЂеЋ–жѕ№ж›ўжўєйЌќе‹­в–‰й–ёе¬§еЃ“й—Ѓз?оѓ†йЋёжђЃпЅће©µе¬«еЂ·ж¤¤жЋ†еЃ“ж¤¤еїҐж‹?
    assign dequeue_data1 = ram[head];
    assign dequeue_data2 = ram[head_plus];



    // й—‚е‚љеЂёйЌЉжђЃеґђе®„ж‡ЉеЅ’еґ¶и¤‰йЏ‹ж ­жџЎйЌҐгѓҐзЃ©зјЃж„­ољЉйЄћж §ЗЋйЎ’в‚¬й€§о„Ѓећ¶з»‚е¶€гЃђйЋєж’¶еЋЄжї з”µеЃџйЌ‹ж’ів–ЌйЌ›о†»з№†ж¤¤ж„¶зј‰йЋґп№ўгО¦й–ёж›Ёећ°з» з»гЃ„йЏЌг„¤з·±жїће…јећїе§ЉжґЄеґ«йЉ‰гѓ¦зўг»е©µз‚ІжЁЉйЌ™е†Ёо‡Јжї ж°­еЃ„й–ёж’іеј¶ж•€й—ЃзЎ…еЃђзђ›гѓ©еџЂйЎ’в‚¬йЌџи·ЁзІ»й”ќе¤‹в’’еЁґпЅ€е§¤йЉ†е†®жџЈйЋєз‚µз•µжҐ з‚ґећїе®•жѓ°о™Ѓй–ёг‚†жґйЉ‡е‹Їе№’йЋґжїђд»јй–ёгѓ¦жЊіе§Љи™№еЊ–йЏ‡з‚Ів’‰е¦ћг‚ѓеЉЊз»»ж€ в‚¬йќ›г‚ёйЄћжЁјзґ’е¦Їй”‹е«Ѕе©µз‚¶жЏЄзјЌв‚¬е©µо†єеЂ—еЁ‘з”ёеґјйЏ‡з†єеЋ±й—Ѓз»ГЄйЌџжЊЋж…Ёе®Ґе›ЈеЃ“еЁ€ећ®жћ›й–№иЇ§зґ•йЋ№г€ в”‘йЌЎв•‚еѓµе¦ћг‚†её’йЌ‹е—›еґ¬йђўе‘Љв’’еЁґпЅ€ж«Јз”Їж¶ўжџ›йЉЉгѓҐж‚‘й–№дѕїеЉ‘жїЎи€µеѕ„жї е‹¬з…Јй—‚дЅёз¶Ље¦«еќ—ж‚ћй”•е‚›еЃ‚жїћж€™ећєйђ“ж›ўж‚йђђж‰®з•Ѕж¤¤еї“з‰†йђ’ећ«гЃ„йЋєе¶€е…Ње©ўС‡дє¶йЏЊе¶€о™Ѓй–ёж’ґеІёйЋіжї‹еґњи¤Џз»Ђе©‚в”‘йђеЏ‰жђђй–Ѕе†Єе––йЏЊж›џз№›йђђо„ЃзЏ•й—Ѓз?оѓ…зўгљдјґеј»й”ќе¤Љз…›й–ёе±ѕеІёйЌ¤е¬¬зґ“жµЈе“„РЈй–№з‘°жґ¤йЎ•пЅ‰о”•й”•в‚¬з» ж¶™гЃ„йЏЌг„§зџЊй–єе¤‹ж‚‚е§ЉжґЄеґ«йЌ•о‚џеЃ“и¤°жЋќж•„жїће—еЉ•йЎ•йЃЌжџџйЌ“С…её›й–ій”‹её’йњ‰й–їжї†з‰†иўљзјЃз»ўеЋјйђ–еҐёеј»еЁ‘г€ЎеЃђй–ёж„­еЅѓйЎ«жЋ—ж‚—еЁ€ећ®жћ›й–№иЇ§зґ•йЋ№г€ в”‘йЌЎв•‚еѓµе¦ћг‚†её’йЌ‹е—›еґ¬йђўе‘Љв’’еЁґпЅ€ж«Јз”Їж¶ўжџ›йЉЉгѓҐж‚‘й–№дѕїеЉ‘жїЎи€µеѕ„жї е‹¬з…Јй—‚дЅёз¶Ље¦«еќ—ж‚ћй”•е‚›еЃ‚жїћж€™ећєйђ“ж›ўж‚йђђж‰®з•Ѕж¤¤еї“з‰†йђ’ећ«гЃ„йЋєе¶€е…Ње©ўС‡дє¶йЏЊе¶€о™Ѓй–ёж’ґеІёйЋіжї‹еґњи¤Џз»Ђе©‚в”‘йђеЏ‰жђђй–Ѕе†Єе––йЏЊж›џз№›йђђо„ЃзЏ•й—Ѓз?оѓ…зўгљо„„е¦ґйЋєж€­жЅ©й–»ж’іжµ·жµ С‡жўєе§№е›§еЉґеЁґж»…еЃџе¦Іж„°е№’йЏѓе‚њпјњй—Ѓйќ›з№’жї®еЇёзЊѕе®Ґе¤‹в’‘йђћж¶’в‚¬е……еЈ•й—Ѓе“„оЇйђ—е†®еј¬жёљв‚¬е®•ж€¦е№йЋ°дЅ№еѓµй—Ѓз»еЉ¦йЌ“ж¬“о””й”џпї?
    wire stall;
    assign stall = (head == (tail + 3) % `DEPTH);
    assign full = (head == (tail_plus + 1) % `DEPTH) || (head == tail_plus);
    assign empty = (head == tail) || (head == tail_plus);

    assign get_data_req = !(stall || full);

endmodule